version: "2"

<% @Count = 4 %>

services:
  redis:
    image: redis
    command: redis-server --appendonly yes

<% for @n in 1..@Count %>
  phoenix-<%= @n %>:
    image: bitwalker/alpine-elixir-phoenix:latest
    volumes:
      - .:/opt/app
    environment:
      PORT: '<%= 4000 + @n %>'
      REDIS_HOST: 'redis'
    ports:
      - <%= 4000 + @n %>:<%= 4000 + @n %>
    depends_on:
      - redis
    working_dir: /opt/app
    command: mix phx.server
<% end %>
